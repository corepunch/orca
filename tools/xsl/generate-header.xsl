<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:output method="text" encoding="UTF-8"/>
    
    <!-- Main template for header file generation -->
    <xsl:template match="/module">
        <xsl:text>// Generated by XSLT code generator&#10;</xsl:text>
        <xsl:text>#ifndef __</xsl:text>
        <xsl:call-template name="toUpper">
            <xsl:with-param name="text" select="@name"/>
        </xsl:call-template>
        <xsl:text>_H__&#10;</xsl:text>
        <xsl:text>#define __</xsl:text>
        <xsl:call-template name="toUpper">
            <xsl:with-param name="text" select="@name"/>
        </xsl:call-template>
        <xsl:text>_H__&#10;&#10;</xsl:text>
        
        <xsl:text>#include &lt;include/orca.h&gt;&#10;&#10;</xsl:text>
        
        <!-- Include custom headers -->
        <xsl:apply-templates select="include"/>
        
        <!-- Forward declarations for structs, interfaces, and components -->
        <xsl:apply-templates select="struct|interface|component" mode="forward"/>
        
        <!-- Struct definitions -->
        <xsl:apply-templates select="struct|interface|component" mode="definition"/>
        
        <xsl:text>&#10;#endif&#10;</xsl:text>
    </xsl:template>
    
    <!-- Include directive -->
    <xsl:template match="include">
        <xsl:text>#include &lt;</xsl:text>
        <xsl:value-of select="@file"/>
        <xsl:text>&gt;&#10;</xsl:text>
    </xsl:template>
    
    <!-- Forward declarations -->
    <xsl:template match="struct|interface|component" mode="forward">
        <xsl:text>typedef struct </xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:text> </xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:text>_t;&#10;</xsl:text>
    </xsl:template>
    
    <!-- Struct/Interface/Component definitions -->
    <xsl:template match="struct|interface|component" mode="definition">
        <xsl:text>&#10;// </xsl:text>
        <xsl:value-of select="summary"/>
        <xsl:text>&#10;struct </xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:text> {&#10;</xsl:text>
        
        <!-- Parent inheritance (if specified) -->
        <xsl:if test="@parent">
            <xsl:text>    </xsl:text>
            <xsl:value-of select="@parent"/>
            <xsl:text>_t base;&#10;</xsl:text>
        </xsl:if>
        
        <!-- Fields -->
        <xsl:apply-templates select="field"/>
        
        <!-- Properties (for components) -->
        <xsl:apply-templates select="property"/>
        
        <xsl:text>};&#10;</xsl:text>
        
        <!-- Method declarations -->
        <xsl:apply-templates select="method" mode="declaration"/>
    </xsl:template>
    
    <!-- Field definition -->
    <xsl:template match="field">
        <xsl:text>    </xsl:text>
        <xsl:if test="@const = 'true'">
            <xsl:text>const </xsl:text>
        </xsl:if>
        <xsl:value-of select="@type"/>
        <xsl:if test="@pointer = 'true'">
            <xsl:text>*</xsl:text>
        </xsl:if>
        <xsl:text> </xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:if test="@array">
            <xsl:text>[</xsl:text>
            <xsl:value-of select="@array"/>
            <xsl:text>]</xsl:text>
        </xsl:if>
        <xsl:text>;&#10;</xsl:text>
    </xsl:template>
    
    <!-- Property definition (for components) -->
    <xsl:template match="property">
        <xsl:text>    </xsl:text>
        <xsl:value-of select="@type"/>
        <xsl:text> </xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:text>;&#10;</xsl:text>
    </xsl:template>
    
    <!-- Method declaration -->
    <xsl:template match="method" mode="declaration">
        <xsl:text>&#10;</xsl:text>
        <xsl:choose>
            <xsl:when test="returns">
                <xsl:if test="returns/@const = 'true'">
                    <xsl:text>const </xsl:text>
                </xsl:if>
                <xsl:value-of select="returns/@type"/>
                <xsl:if test="returns/@pointer = 'true'">
                    <xsl:text>*</xsl:text>
                </xsl:if>
            </xsl:when>
            <xsl:otherwise>
                <xsl:text>void</xsl:text>
            </xsl:otherwise>
        </xsl:choose>
        <xsl:text> </xsl:text>
        <xsl:value-of select="../@name"/>
        <xsl:text>_</xsl:text>
        <xsl:value-of select="@name"/>
        <xsl:text>(</xsl:text>
        
        <!-- Self parameter -->
        <xsl:choose>
            <xsl:when test="@const = 'true'">
                <xsl:text>const </xsl:text>
            </xsl:when>
        </xsl:choose>
        <xsl:value-of select="../@name"/>
        <xsl:text>_t* self</xsl:text>
        
        <!-- Additional arguments -->
        <xsl:for-each select="arg">
            <xsl:text>, </xsl:text>
            <xsl:if test="@const = 'true'">
                <xsl:text>const </xsl:text>
            </xsl:if>
            <xsl:value-of select="@type"/>
            <xsl:if test="@pointer = 'true'">
                <xsl:text>*</xsl:text>
            </xsl:if>
            <xsl:text> </xsl:text>
            <xsl:value-of select="@name"/>
        </xsl:for-each>
        
        <xsl:text>);&#10;</xsl:text>
    </xsl:template>
    
    <!-- Utility template to convert text to uppercase -->
    <xsl:template name="toUpper">
        <xsl:param name="text"/>
        <xsl:value-of select="translate($text, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')"/>
    </xsl:template>
    
</xsl:stylesheet>
